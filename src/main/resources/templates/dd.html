<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div id="chat">
    <div id="messages"></div>
    <input type="text" id="messageInput" />
    <button onclick="sendMessage()">Send</button>
    <button onclick="loadHistoryViaRest()">Load History via REST</button>
</div>

<script>
    var socket = new SockJS('/chat');
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/messages', function(message) {
            showMessage(JSON.parse(message.body));
        });
        loadHistory(); // 자동으로 히스토리를 로드하도록 합니다.
    });

    function sendMessage() {
        var messageContent = document.getElementById('messageInput').value;
        if(messageContent) {
            stompClient.send("/app/send", {}, JSON.stringify({
                senderId: 'buyer',
                chatRoomId: 'room1',
                message: messageContent
            }));
            document.getElementById('messageInput').value = '';
        }
    }

    function showMessage(message) {
        var messagesDiv = document.getElementById('messages');
        var messageElement = document.createElement('div');
        messageElement.innerText = message.senderId + ": " + message.message;
        messagesDiv.appendChild(messageElement);
    }

    function loadHistory() {
        stompClient.send("/app/history/room1", {});
    }

    function showHistory(messages) {
        var messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = ''; // 이전 메시지를 지웁니다.
        messages.forEach(showMessage);
    }

    function loadHistoryViaRest() {
        fetch('/history/room1')
            .then(response => response.json())
            .then(messages => {
                if (Array.isArray(messages)) {
                    var messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = ''; // 이전 메시지를 지웁니다.
                    messages.forEach(showMessage);
                } else {
                    console.error("Expected an array but got:", messages);
                }
            })
            .catch(error => {
                console.error("Error loading history:", error);
            });
    }

</script>
</body>
</html>
